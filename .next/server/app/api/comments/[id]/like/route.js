"use strict";(()=>{var e={};e.id=407,e.ids=[407],e.modules={98860:e=>{e.exports=require("jsdom")},11185:e=>{e.exports=require("mongoose")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},25528:e=>{e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},91877:e=>{e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},25319:e=>{e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},68761:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>f,originalPathname:()=>x,patchFetch:()=>q,requestAsyncStorage:()=>y,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>w});var s={};r.r(s),r.d(s,{POST:()=>c});var i=r(95419),a=r(69108),o=r(99678),n=r(78070),u=r(81355),l=r(22345),p=r(89166),d=r(4118);async function c(e,{params:t}){let r=await (0,u.getServerSession)(d.authOptions);if(!r?.user)return n.Z.json({error:"请先登录"},{status:401});try{await (0,l.u)();let e=await p.Z.findById(t.id);if(!e)return n.Z.json({error:"评论不存在"},{status:404});let s=r.user.id,i=e.likedBy.indexOf(s);return -1===i?(e.likes+=1,e.likedBy.push(s)):(e.likes-=1,e.likedBy.splice(i,1)),await e.save(),n.Z.json({likes:e.likes,isLiked:-1===i})}catch(e){return console.error("处理点赞失败:",e),n.Z.json({error:"处理点赞失败"},{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/comments/[id]/like/route",pathname:"/api/comments/[id]/like",filename:"route",bundlePath:"app/api/comments/[id]/like/route"},resolvedPagePath:"C:\\Users\\Lenovo\\Desktop\\低空网站原始\\app\\api\\comments\\[id]\\like\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:g,headerHooks:f,staticGenerationBailout:w}=m,x="/api/comments/[id]/like/route";function q(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}},4118:(e,t,r)=>{r.r(t),r.d(t,{GET:()=>p,POST:()=>p,authOptions:()=>l});var s=r(49605),i=r(86485),a=r(6521),o=r.n(a),n=r(22345),u=r(52055);let l={providers:[(0,i.Z)({name:"credentials",credentials:{email:{label:"邮箱",type:"email"},password:{label:"密码",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("请输入邮箱和密码");await (0,n.u)();let t=await u.Z.findOne({email:e.email});if(!t)throw Error("用户不存在");if(!await o().compare(e.password,t.password))throw Error("密码错误");return{id:t._id.toString(),name:t.name,email:t.email,role:t.role}}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/login",signOut:"/",error:"/login"},session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET},p=(0,s.default)(l)},22345:(e,t,r)=>{r.d(t,{u:()=>n});var s=r(11185),i=r.n(s);let a=process.env.MONGODB_URI;if(!a)throw Error("请在环境变量中设置 MONGODB_URI");let o=!1;async function n(){if(o){console.log("已连接到 MongoDB");return}try{let e=await i().connect(a);o=1===e.connections[0].readyState,console.log("MongoDB 连接成功")}catch(e){throw console.error("MongoDB 连接失败:",e),e}}},89166:(e,t,r)=>{r.d(t,{Z:()=>u});var s=r(11185),i=r(87709),a=r.n(i);let o=new s.Schema({content:{type:String,required:[!0,"回复内容不能为空"],maxlength:[1e4,"回复内容不能超过10000个字符"],set:e=>a().sanitize(e)},author:{type:s.Schema.Types.ObjectId,ref:"User",required:!0},likes:{type:Number,default:0},likedBy:[{type:s.Schema.Types.ObjectId,ref:"User"}],createdAt:{type:Date,default:Date.now}}),n=new s.Schema({content:{type:String,required:[!0,"评论内容不能为空"],maxlength:[1e4,"评论内容不能超过10000个字符"],set:e=>a().sanitize(e)},author:{type:s.Schema.Types.ObjectId,ref:"User",required:!0},newsId:{type:String,required:!0},likes:{type:Number,default:0},likedBy:[{type:s.Schema.Types.ObjectId,ref:"User"}],replies:[o],replyCount:{type:Number,default:0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});n.pre("save",function(e){this.replies&&(this.replyCount=this.replies.length),e()}),n.pre("save",function(e){this.updatedAt=new Date,e()});let u=s.models.Comment||(0,s.model)("Comment",n)},52055:(e,t,r)=>{r.d(t,{Z:()=>a});var s=r(11185);let i=new s.Schema({name:{type:String,required:[!0,"请输入用户名"]},email:{type:String,required:[!0,"请输入邮箱"],unique:!0,lowercase:!0,trim:!0},password:{type:String,required:[!0,"请输入密码"],minlength:[6,"密码至少6个字符"]},role:{type:String,enum:["user","admin"],default:"user"},avatar:{type:String,default:""},company:{type:String,default:""},position:{type:String,default:""},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});i.pre("save",function(e){this.updatedAt=new Date,e()});let a=s.models.User||(0,s.model)("User",i)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[638,206,521,255,338],()=>r(68761));module.exports=s})();